(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{7181:function(e,t,s){Promise.resolve().then(s.bind(s,3146))},3146:function(e,t,s){"use strict";s.d(t,{AppComponent:function(){return P}});var r=s(7437),a=s(2265),l=s(2660),i=s(3247),n=s(2369),c=s(740),o=s(2489),d=s(407),u=s(4938),m=s(8997),h=s(7689),x=s(3581),f=s(7168),g=s(8728),b=s(6595),p=s(1723),j=s(3464),w=s(7310),v=s.n(w);let y=j.Z.create({baseURL:"/api"});y.interceptors.request.use(e=>{let t=localStorage.getItem("token");return t&&(e.headers.Authorization=t),e},e=>Promise.reject(e));let N=e=>e.startsWith("http://")?"/api/proxy/image?url=".concat(encodeURIComponent(e)):e,k=e=>{let{isLoggedIn:t,onLoginClick:s,showBackButton:a=!1,onBackClick:c,title:o="文物数据库"}=e;return(0,r.jsxs)("header",{className:"flex justify-between items-center p-4 bg-white border-b border-gray-200",children:[a?(0,r.jsx)("button",{onClick:c,className:"text-red-700",children:(0,r.jsx)(l.Z,{className:"w-6 h-6"})}):(0,r.jsx)("h1",{className:"text-xl font-bold text-gray-800",children:o}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("button",{className:"text-red-700 mr-4",children:(0,r.jsx)(i.Z,{className:"w-6 h-6"})}),!t&&(0,r.jsx)("button",{onClick:s,className:"text-red-700",children:(0,r.jsx)(n.Z,{className:"w-6 h-6"})})]})]})},C=e=>{let{activeCategory:t,onCategoryChange:s,onFilterClick:a,classification:l}=e,i=["古币","珍宝","陶瓷","书画"],n=Object.values(l).map(e=>e.unicode),o=n.length>=i.length?n:[...n,...i.slice(n.length)];return(0,r.jsxs)("nav",{className:"flex items-center p-2 bg-white border-b border-gray-200",children:[(0,r.jsx)("button",{className:"p-2 text-red-700 mr-2",onClick:a,children:(0,r.jsx)(c.Z,{className:"w-6 h-6"})}),(0,r.jsx)("div",{className:"flex overflow-x-auto whitespace-nowrap",children:o.map(e=>(0,r.jsx)("button",{className:"px-3 py-2 text-sm font-medium ".concat(e===t?"text-red-700 border-b-2 border-red-700":"text-gray-600"),onClick:()=>s(e),children:e},e))})]})},S=e=>{let t,{isOpen:s,onClose:l,onFilterChange:i,classification:n}=e,[c,d]=(0,a.useState)(0),[u,m]=(0,a.useState)(["","","","","",""]);(0,a.useEffect)(()=>{s&&(d(0),m(["","","","","",""]))},[s]);let h=(e,t)=>{let s=[...u];s[t]=e,s.fill("",t+1),m(s),i(s);let r=n;for(let e=0;e<=t;e++)if(r[s[e]])r=r[s[e]].childs;else{r={};break}0===Object.keys(r).length||5===t?l():d(t+1)};return s?(0,r.jsxs)("div",{className:"absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg p-4 w-64 z-50",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h2",{className:"text-lg font-bold",children:"筛选"}),(0,r.jsx)("button",{onClick:l,children:(0,r.jsx)(o.Z,{className:"w-5 h-5"})})]}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:(t=n,u.filter(Boolean).map((e,s)=>{var r,a;let l=(null===(r=t[e])||void 0===r?void 0:r.unicode)||"";return t=(null===(a=t[e])||void 0===a?void 0:a.childs)||{},l}).join(" - "))}),(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:(()=>{let e=n;for(let t=0;t<c;t++){if(!e[u[t]])return null;e=e[u[t]].childs}return Object.entries(e).map(e=>{let[t,s]=e;return(0,r.jsx)("button",{className:"px-3 py-1 text-sm text-gray-700 hover:bg-red-50 rounded",onClick:()=>h(t,c),children:s.unicode},t)})})()})]})]}):null},I=e=>{let{username:t,userId:s,isLoggedIn:a,onLoginClick:l}=e;return(0,r.jsx)("div",{className:"relative h-48 bg-gradient-to-b from-red-700 to-red-800 flex items-end",children:(0,r.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 flex items-end p-4",children:[(0,r.jsx)("div",{className:"w-16 h-16 rounded-full bg-white border-4 border-white overflow-hidden",children:a?(0,r.jsx)("img",{src:"http://ui-avatars.com/api/?name=".concat(encodeURIComponent(t||"")),alt:"Profile",className:"w-full h-full object-cover"}):(0,r.jsx)(n.Z,{className:"w-full h-full text-gray-400"})}),(0,r.jsx)("div",{className:"ml-4 mb-1 flex-grow",children:a?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-white",children:t}),(0,r.jsxs)("p",{className:"text-xs text-red-100",children:["用户ID: ",s]})]}):(0,r.jsx)("button",{onClick:l,className:"px-4 py-2 bg-white text-red-700 rounded-full font-medium",children:"请登录"})})]})})},E=e=>{let{icon:t,title:s,onClick:a,disabled:l=!1}=e;return(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 ".concat(l?"opacity-50 cursor-not-allowed":"cursor-pointer"),onClick:l?void 0:a,children:[(0,r.jsxs)("div",{className:"flex items-center",children:[t,(0,r.jsx)("span",{className:"ml-4 text-gray-700",children:s})]}),(0,r.jsx)(d.Z,{className:"w-5 h-5 text-gray-400"})]})},Z=e=>{let{id:t,image:s,title:a,subtitle:l,onClick:i}=e;return(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md overflow-hidden cursor-pointer",onClick:()=>i(t),children:[(0,r.jsx)("div",{className:"aspect-square bg-gray-200 mb-2",children:(0,r.jsx)("img",{src:N(s)||"/placeholder.svg?height=200&width=200",alt:a,className:"w-full h-full object-cover"})}),(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h3",{className:"text-sm font-medium truncate text-gray-800",children:a}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:l})]})]})},F=e=>{let{filter:t,onArtifactClick:s,artifacts:a,loading:l,hasMore:i,setPage:n,lastArtifactElementRef:c}=e;return(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 p-4",children:[a.map((e,t)=>(0,r.jsx)("div",{ref:t===a.length-1?c:null,children:(0,r.jsx)(Z,{id:e.pid,image:e.url,title:e.title,subtitle:"",onClick:s})},e.pid)),l&&(0,r.jsx)("p",{className:"col-span-2 text-center text-gray-500",children:"加载中..."}),!i&&a.length>0&&(0,r.jsx)("p",{className:"col-span-2 text-center text-gray-500",children:"没有更多数据了"}),!l&&0===a.length&&(0,r.jsx)("p",{className:"col-span-2 text-center text-gray-500",children:"没有找到相关文物"})]})},R=e=>{let{activePage:t,onPageChange:s}=e;return(0,r.jsxs)("nav",{className:"fixed bottom-0 left-0 right-0 flex justify-around items-end bg-white border-t border-gray-200 p-2",children:[(0,r.jsxs)("button",{className:"flex flex-col items-center ".concat("database"===t?"text-red-700":"text-gray-600"),onClick:()=>s("database"),children:[(0,r.jsx)(u.Z,{className:"w-6 h-6"}),(0,r.jsx)("span",{className:"text-xs",children:"数据库"})]}),(0,r.jsx)("button",{className:"flex flex-col items-center relative -top-2",onClick:()=>s("identify"),children:(0,r.jsx)("div",{className:"w-[70px] h-[70px] rounded-full bg-red-700 flex items-center justify-center text-white absolute bottom-0",children:"识别"})}),(0,r.jsxs)("button",{className:"flex flex-col items-center ".concat("profile"===t?"text-red-700":"text-gray-600"),onClick:()=>s("profile"),children:[(0,r.jsx)(n.Z,{className:"w-6 h-6"}),(0,r.jsx)("span",{className:"text-xs",children:"我的"})]})]})},L=e=>{let{onLogin:t,onSwitchToRegister:s}=e,[l,i]=(0,a.useState)(""),[n,c]=(0,a.useState)(""),[o,d]=(0,a.useState)(""),[u,m]=(0,a.useState)(""),h=async e=>{e.preventDefault(),d(""),m("");try{await t(l,n),m("登录成功"),setTimeout(()=>m(""),500)}catch(e){d(e instanceof Error?e.message:"登录失败，请重试")}};return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:(0,r.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-md w-96",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold mb-6 text-center",children:"登录"}),o&&(0,r.jsx)("p",{className:"text-red-500 text-sm mb-4 animate-fade-in",children:o}),u&&(0,r.jsx)("p",{className:"text-green-500 text-sm mb-4 animate-fade-in",children:u}),(0,r.jsxs)("form",{onSubmit:h,className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700",children:"用户名"}),(0,r.jsx)("input",{type:"text",id:"username",value:l,onChange:e=>i(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"密码"}),(0,r.jsx)("input",{type:"password",id:"password",value:n,onChange:e=>c(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"})]}),(0,r.jsx)("button",{type:"submit",className:"w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:"登录"})]}),(0,r.jsx)("div",{className:"mt-4 text-center",children:(0,r.jsx)("button",{onClick:s,className:"text-sm text-red-600 hover:text-red-500",children:"还没有账号？注册"})})]})})},T=e=>{let{onRegister:t,onSwitchToLogin:s}=e,[l,i]=(0,a.useState)(""),[n,c]=(0,a.useState)(""),[o,d]=(0,a.useState)(""),[u,m]=(0,a.useState)(""),[h,x]=(0,a.useState)(""),f=async e=>{if(e.preventDefault(),m(""),x(""),n!==o){m("密码不匹配");return}try{await t(l,n),x("注册成功"),setTimeout(()=>x(""),500)}catch(e){m(e instanceof Error?e.message:"注册失败，请重试")}};return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:(0,r.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-md w-96",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold mb-6 text-center",children:"注册"}),u&&(0,r.jsx)("p",{className:"text-red-500 text-sm mb-4 animate-fade-in",children:u}),h&&(0,r.jsx)("p",{className:"text-green-500 text-sm mb-4 animate-fade-in",children:h}),(0,r.jsxs)("form",{onSubmit:f,className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700",children:"用户"}),(0,r.jsx)("input",{type:"text",id:"username",value:l,onChange:e=>i(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"密码"}),(0,r.jsx)("input",{type:"password",id:"password",value:n,onChange:e=>c(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"r_password",className:"block text-sm font-medium text-gray-700",children:"确认密码"}),(0,r.jsx)("input",{type:"password",id:"r_password",value:o,onChange:e=>d(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"})]}),(0,r.jsx)("button",{type:"submit",className:"w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:"注册"})]}),(0,r.jsx)("div",{className:"mt-4 text-center",children:(0,r.jsx)("button",{onClick:s,className:"text-sm text-red-600 hover:text-red-500",children:"已有账号？登录"})})]})})},B=e=>{let{pid:t,onBack:s,showToast:l}=e,[i,n]=(0,a.useState)(null),[c,o]=(0,a.useState)(!0),[d,u]=(0,a.useState)(!1),h=(0,a.useCallback)(v()(async e=>{let t=localStorage.getItem("token");if(t)try{await j.Z.post("/api/user-actions/record",{pid:e,timestamp:Date.now()},{headers:{Authorization:t}})}catch(e){console.error("Failed to record history:",e)}},1e3),[]);(0,a.useEffect)(()=>{(async()=>{try{let e=(await j.Z.get("/api/artifacts/search?id=".concat(t))).data;n(e),h(t);let s=(await y.get("/user-actions/favorite")).data;console.log(s.some(e=>e.pid==t)),u(s.some(e=>e.pid==t))}catch(e){console.error("Failed to fetch artifact details:",e)}finally{o(!1)}})()},[t,h]);let x=async()=>{try{d?(await y.delete("/user-actions/favorite",{data:{pid:t}}),u(!1),l("已取消收藏","success")):(await y.post("/user-actions/favorite",{pid:t}),u(!0),l("已添加到收藏","success"))}catch(e){console.error("Failed to update favorite:",e),l("操作失败，请重试","error")}};return c?(0,r.jsx)("div",{className:"flex justify-center items-center h-screen",children:"加载中..."}):i?(0,r.jsxs)("div",{className:"min-h-screen bg-white",children:[(0,r.jsx)(k,{showBackButton:!0,onBackClick:s,title:i.title,isLoggedIn:!1,onLoginClick:()=>{}}),(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsx)("img",{src:N(i.img)||"/placeholder.svg?height=200&width=200",alt:i.title,className:"w-full h-64 object-cover rounded-lg mb-4"}),(0,r.jsx)("h2",{className:"text-2xl font-bold mb-2",children:i.title}),(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:i.text}),(0,r.jsxs)("button",{onClick:x,className:"flex items-center justify-center w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ".concat(d?"bg-gray-600 hover:bg-gray-700":"bg-red-600 hover:bg-red-700"," focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"),children:[(0,r.jsx)(m.Z,{className:"w-5 h-5 mr-2 ".concat(d?"fill-current":"")}),d?"取消收藏":"加入收藏"]})]})]}):(0,r.jsx)("div",{className:"flex justify-center items-center h-screen",children:"未找到文物信息"})},O=e=>{let{onBack:t,onArtifactClick:s}=e,[l,i]=(0,a.useState)([]),[n,c]=(0,a.useState)(!1),[o,d]=(0,a.useState)(1),[u,m]=(0,a.useState)(!0),h=(0,a.useCallback)(async()=>{if(!n&&u){c(!0);try{let e=(await y.get("/user-actions/history",{params:{page:o,limit:15}})).data,t=await Promise.all(e.map(async e=>{let t=await y.get("/artifacts/search?id=".concat(e.pid));return{id:e.id,pid:e.pid,url:N(t.data.img),title:t.data.title,timestamp:e.timestamp}}));i(e=>[...e,...t]),m(15===t.length),d(e=>e+1)}catch(e){console.error("Failed to fetch history:",e)}finally{c(!1)}}},[o,n,u]);(0,a.useEffect)(()=>{h()},[]);let x=(0,a.useRef)(),f=(0,a.useCallback)(e=>{!n&&(x.current&&x.current.disconnect(),x.current=new IntersectionObserver(e=>{e[0].isIntersecting&&u&&h()}),e&&x.current.observe(e))},[n,u,h]);return(0,r.jsxs)("div",{className:"min-h-screen bg-white",children:[(0,r.jsx)(k,{showBackButton:!0,onBackClick:t,title:"浏览历史",isLoggedIn:!0,onLoginClick:()=>{}}),(0,r.jsxs)("div",{className:"p-4",children:[0!==l.length||n?(0,r.jsx)("ul",{className:"divide-y divide-gray-200",children:l.map((e,t)=>(0,r.jsx)("li",{className:"py-4 cursor-pointer",onClick:()=>s(e.pid),ref:t===l.length-1?f:null,children:(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsx)("img",{className:"h-12 w-12 rounded-md",src:e.url,alt:e.title})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.title}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:new Date(e.timestamp).toLocaleString()})]})]})},e.id))}):(0,r.jsx)("p",{className:"text-center text-gray-600",children:"暂无浏览历史"}),n&&(0,r.jsx)("p",{className:"text-center text-gray-600",children:"加载中..."})]})]})},A=e=>{let{onBack:t,onArtifactClick:s,showToast:l}=e,[i,n]=(0,a.useState)([]),[c,d]=(0,a.useState)(!1),[u,m]=(0,a.useState)(1),[h,x]=(0,a.useState)(!0),f=(0,a.useCallback)(async()=>{if(!c&&h){d(!0);try{let e=(await y.get("/user-actions/favorite",{params:{page:u,limit:15}})).data,t=await Promise.all(e.map(async e=>{let t=await y.get("/artifacts/search?id=".concat(e.pid));return{id:e.id,pid:e.pid,url:N(t.data.img),title:t.data.title}}));n(e=>[...e,...t]),x(15===t.length),m(e=>e+1)}catch(e){console.error("Failed to fetch favorites:",e),l("获取收藏失败","error")}finally{d(!1)}}},[u,c,h,l]);(0,a.useEffect)(()=>{f()},[]);let g=(0,a.useRef)(),b=(0,a.useCallback)(e=>{!c&&(g.current&&g.current.disconnect(),g.current=new IntersectionObserver(e=>{e[0].isIntersecting&&h&&f()}),e&&g.current.observe(e))},[c,h,f]),p=async e=>{try{await y.delete("/user-actions/favorite",{data:{pid:e}}),l("已从收藏中移除","success"),n(t=>t.filter(t=>t.pid!==e))}catch(e){console.error("Failed to remove favorite:",e),l("移除收藏失败","error")}};return(0,r.jsxs)("div",{className:"min-h-screen bg-white",children:[(0,r.jsx)(k,{showBackButton:!0,onBackClick:t,title:"我的收藏",isLoggedIn:!0,onLoginClick:()=>{}}),(0,r.jsxs)("div",{className:"p-4",children:[0!==i.length||c?(0,r.jsx)("div",{className:"grid grid-cols-2 gap-4",children:i.map((e,t)=>(0,r.jsxs)("div",{className:"relative",ref:t===i.length-1?b:null,children:[(0,r.jsxs)("div",{className:"cursor-pointer",onClick:()=>s(e.pid),children:[(0,r.jsx)("img",{src:e.url,alt:e.title,className:"w-full h-40 object-cover rounded-lg"}),(0,r.jsx)("p",{className:"mt-2 text-sm font-medium text-gray-900 truncate",children:e.title})]}),(0,r.jsx)("button",{onClick:()=>p(e.pid),className:"absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:(0,r.jsx)(o.Z,{className:"w-4 h-4"})})]},e.id))}):(0,r.jsx)("p",{className:"text-center text-gray-600",children:"暂无收藏"}),c&&(0,r.jsx)("p",{className:"text-center text-gray-600",children:"加载中..."})]})]})},D=e=>{let{message:t,type:s,onClose:l}=e,[i,n]=(0,a.useState)(!1),[c,d]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{n(!0);let e=setTimeout(()=>{d(!0),setTimeout(l,500)},1500);return()=>clearTimeout(e)},[l]),(0,r.jsx)("div",{className:"\n        fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-4 rounded-md shadow-md \n        ".concat("success"===s?"bg-green-500":"bg-red-700"," text-white\n        transition-all duration-500 ease-in-out\n        ").concat(i?c?"-translate-y-full opacity-0":"translate-y-0 opacity-100":"-translate-y-full opacity-0","\n      "),children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("span",{children:t}),(0,r.jsx)("button",{onClick:()=>d(!0),className:"ml-2",children:(0,r.jsx)(o.Z,{size:18})})]})})},_=e=>{let{showToast:t,setCameraCleanupCallback:s}=e,[l,i]=(0,a.useState)(null),[n,c]=(0,a.useState)(null),o=(0,a.useRef)(null),d=(0,a.useRef)(null),u=(0,a.useRef)(null),[m,g]=(0,a.useState)("environment"),[b,p]=(0,a.useState)(!1),j=(0,a.useRef)(null),w=(0,a.useCallback)(async()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:m}}});d.current&&(d.current.srcObject=e,j.current=e,p(!0))}catch(e){console.error("摄像头访问失败:",e),t("无法访问指定的摄像头，尝试使用其他摄像头","error"),g(e=>"user"===e?"environment":"user")}},[m,t]),v=(0,a.useCallback)(()=>{j.current&&(j.current.getTracks().forEach(e=>e.stop()),d.current&&(d.current.srcObject=null),j.current=null,p(!1))},[]);(0,a.useEffect)(()=>(w(),()=>{v()}),[m,w,v]),(0,a.useEffect)(()=>(s(()=>v),()=>{s(null)}),[v,s]);let y=(0,a.useCallback)(async()=>{await v(),g(e=>"user"===e?"environment":"user")},[v]),N=async()=>{if(l)try{let e=new FormData,s=await fetch(l).then(e=>e.blob());e.append("file",s,"image.jpg");let r=await fetch("/api/upload",{method:"POST",body:e}),a=await r.json();if("success"==a.message)t("识别成功","success"),c(Array.isArray(a.itemInfo)?a.itemInfo:[]);else if("failed"===a.message){let e="识别失败";switch(a.error){case"no_codebar":e="未识别到条形码";break;case"no_item":e="未检测到物品";break;case"no_access":e="未找到评级信息"}c(null),t(e,"error")}else c(null),t("识别过程出错","error")}catch(e){console.error("识别过程出错:",e),c(null),t("识别过程出错，请重试","error")}};return(0,r.jsxs)("div",{className:"p-4",children:[l?(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("div",{className:"relative w-full pb-[120%] mb-4",children:(0,r.jsx)("img",{src:l,alt:"Captured",className:"absolute top-0 left-0 w-full h-full object-cover rounded-lg"})}),(0,r.jsx)("button",{onClick:N,className:"w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 mb-2",children:"开始识别"}),n&&n.length>0&&(0,r.jsx)("div",{className:"mt-4 p-4 bg-gray-100 rounded-lg",children:(0,r.jsx)("h3",{className:"font-bold mb-2",children:"识别结果："})}),(0,r.jsx)("button",{onClick:()=>{i(null),c(null),w()},className:"w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700",children:"重新拍照"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"relative w-full pb-[120%] mb-4",children:(0,r.jsx)("video",{ref:d,autoPlay:!0,playsInline:!0,className:"absolute top-0 left-0 w-full h-full object-cover rounded-lg"})}),(0,r.jsxs)("div",{className:"flex justify-around mb-4",children:[(0,r.jsxs)("button",{onClick:()=>{var e;return null===(e=o.current)||void 0===e?void 0:e.click()},className:"flex flex-col items-center bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800",children:[(0,r.jsx)(h.Z,{className:"w-6 h-6 mb-1"}),"上传"]}),(0,r.jsxs)("button",{onClick:()=>{if(!b){w();return}if(d.current&&u.current){let e=d.current,t=u.current,s=e.videoWidth,r=1.2*e.videoWidth;r>e.videoHeight&&(r=e.videoHeight,s=e.videoHeight/1.2),t.width=s,t.height=r;let a=t.getContext("2d");if(a){let l=(e.videoWidth-s)/2,n=(e.videoHeight-r)/2;a.drawImage(e,l,n,s,r,0,0,s,r),i(t.toDataURL("image/jpeg")),v()}}},className:"flex flex-col items-center bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800",children:[(0,r.jsx)(x.Z,{className:"w-6 h-6 mb-1"}),"拍照"]}),(0,r.jsxs)("button",{onClick:y,className:"flex flex-col items-center bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800",children:[(0,r.jsx)(f.Z,{className:"w-6 h-6 mb-1"}),"切换"]}),(0,r.jsx)("input",{type:"file",ref:o,onChange:e=>{var t;v();let s=null===(t=e.target.files)||void 0===t?void 0:t[0];if(s){let e=new FileReader;e.onload=e=>{var t;let s=new Image;s.onload=()=>{let e=document.createElement("canvas"),t=s.width,r=1.2*s.width;r>s.height&&(r=s.height,t=s.height/1.2),e.width=t,e.height=r;let a=e.getContext("2d");if(a){let l=(s.width-t)/2,n=(s.height-r)/2;a.drawImage(s,l,n,t,r,0,0,t,r),i(e.toDataURL("image/jpeg"))}},s.src=null===(t=e.target)||void 0===t?void 0:t.result},e.readAsDataURL(s)}},accept:"image/*",className:"hidden"})]})]}),(0,r.jsx)("canvas",{ref:u,className:"hidden"})]})};function P(){let[e,t]=(0,a.useState)("机制银币"),[s,l]=(0,a.useState)(["jizhiyinbi","","","","",""]),[i,n]=(0,a.useState)("database"),[c,o]=(0,a.useState)(!1),[d,u]=(0,a.useState)(!1),[m,h]=(0,a.useState)(!1),[x,f]=(0,a.useState)(null),[w,v]=(0,a.useState)(null),[N,Z]=(0,a.useState)(!1),[P,U]=(0,a.useState)({}),[q,z]=(0,a.useState)([]),[H,M]=(0,a.useState)(!1),[W,G]=(0,a.useState)(1),[J,K]=(0,a.useState)(!0),Q=(0,a.useRef)(null),[V,X]=(0,a.useState)(!1),[Y,$]=(0,a.useState)(null),[ee,et]=(0,a.useState)(null),[es,er]=(0,a.useState)(!1),[ea,el]=(0,a.useState)({database:["main"],identify:["main"],profile:["main"]}),ei=(0,a.useCallback)(e=>{!H&&(Q.current&&Q.current.disconnect(),Q.current=new IntersectionObserver(e=>{e[0].isIntersecting&&J&&G(e=>e+1)}),e&&Q.current.observe(e))},[H,J]),en=(0,a.useCallback)(async()=>{M(!0);try{let e={c0:s[0],c1:s[1],c2:s[2],c3:s[3],c4:s[4],c5:s[5],page:W,limit:10};Object.keys(e).forEach(t=>""===e[t]&&delete e[t]);let t=(await y.get("/artifacts/searchItems",{params:e})).data;z(e=>1===W?t:[...e,...t]),K(10===t.length)}catch(e){console.error("Failed to fetch artifacts:",e)}finally{M(!1)}},[s,W]);(0,a.useEffect)(()=>{en()},[en]);let ec=(0,a.useCallback)(e=>{l(e),G(1),z([]),K(!0)},[]);(0,a.useEffect)(()=>{let e=localStorage.getItem("token");e&&eo(e)},[]),(0,a.useEffect)(()=>{(async()=>{try{let e=await j.Z.get("/api/artifacts/classification");U(e.data)}catch(e){console.error("Failed to fetch classification:",e)}})()},[]);let eo=async e=>{try{let t=await j.Z.get("/api/users/verify",{headers:{Authorization:e}});if(200===t.status&&t.data){let{username:e,id:s}=t.data;o(!0),f({username:e,userRole:s.toString()})}else eu()}catch(e){console.error("登录状态验证失败:",e),eu()}},ed=async(e,t)=>{try{let s=await j.Z.post("/api/users/login",{username:e,password:t});if(200===s.status&&s.data.token){let{token:e,id:t,username:r}=s.data;localStorage.setItem("token",e),o(!0),f({username:r,userRole:t.toString()}),u(!1)}else throw Error(s.data.message||"登录失败")}catch(e){if(console.error("登录失败:",e),j.Z.isAxiosError(e)&&e.response)throw Error(e.response.data.message||"登录失败，请重试");throw Error("登录失败，请重试")}},eu=()=>{o(!1),f(null),localStorage.removeItem("token")},em=e=>{t(e);let s=[Object.keys(P).find(t=>{var s;return(null===(s=P[t])||void 0===s?void 0:s.unicode)===e})||"","","","","",""];l(s),ec(s)},eh=e=>{v(e),el(e=>({...e,[i]:[...e[i],"detail"]}))},ex=e=>{["database","identify","profile"].includes(e)?(ee&&(ee(),et(null)),n(e),el(t=>({...t,[e]:["main"]})),u(!1),h(!1)):el(t=>({...t,[i]:[...t[i],e]})),window.scrollTo(0,0)},ef=()=>{el(e=>{let t=e[i];return t.length>1?(window.scrollTo(0,0),{...e,[i]:t.slice(0,-1)}):e})},eg=(e,t)=>{$({message:e,type:t})},eb=async(e,t)=>{try{let s=await y.post("/users/register",{username:e,password:t,userRole:"user"});if(200===s.status)eg("注册成功","success"),h(!1),u(!0);else throw Error(s.data.message||"注册失败")}catch(e){if(console.error("注册失败:",e),j.Z.isAxiosError(e)&&e.response)throw Error(e.response.data.message||"册失败，请重试");throw Error("注册失败，请重试")}};return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100 pb-16",children:[(()=>{if(d)return(0,r.jsx)(L,{onLogin:ed,onSwitchToRegister:()=>{u(!1),h(!0)}});if(m)return(0,r.jsx)(T,{onRegister:eb,onSwitchToLogin:()=>{h(!1),u(!0)}});let t=ea[i],a=t[t.length-1];switch(i){case"database":switch(a){case"main":return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(k,{isLoggedIn:c,onLoginClick:()=>u(!0)}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(C,{activeCategory:e,onCategoryChange:em,onFilterClick:()=>er(!es),classification:P}),(0,r.jsx)(S,{isOpen:es,onClose:()=>er(!1),onFilterChange:ec,classification:P})]}),(0,r.jsx)(F,{filter:s,onArtifactClick:eh,artifacts:q,loading:H,hasMore:J,setPage:G,lastArtifactElementRef:ei})]});case"detail":return(0,r.jsx)(B,{pid:w||"",onBack:ef,showToast:eg});default:return null}case"identify":return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(k,{isLoggedIn:c,onLoginClick:()=>u(!0),title:"文物识别"}),(0,r.jsx)(_,{showToast:eg,setCameraCleanupCallback:et})]});case"profile":switch(a){case"main":return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,r.jsx)(I,{username:null==x?void 0:x.username,userId:null==x?void 0:x.userRole,isLoggedIn:c,onLoginClick:()=>u(!0)}),(0,r.jsxs)("div",{className:"mt-2 bg-white",children:[(0,r.jsx)(E,{icon:(0,r.jsx)(g.Z,{className:"w-5 h-5 text-red-700"}),title:"设置",onClick:()=>{},disabled:!c}),(0,r.jsx)(E,{icon:(0,r.jsx)(b.Z,{className:"w-5 h-5 text-red-700"}),title:"收藏",onClick:()=>c?ex("favorites"):eg("请先登录","error"),disabled:!c}),(0,r.jsx)(E,{icon:(0,r.jsx)(p.Z,{className:"w-5 h-5 text-red-700"}),title:"历史",onClick:()=>c?ex("history"):eg("请先登录","error"),disabled:!c}),c&&(0,r.jsx)("button",{onClick:eu,className:"w-full text-left px-4 py-3 text-red-700 font-medium border-t border-gray-200",children:"退出登录"})]})]});case"favorites":return(0,r.jsx)(A,{onBack:ef,onArtifactClick:eh,showToast:eg});case"history":return(0,r.jsx)(O,{onBack:ef,onArtifactClick:eh});case"detail":return(0,r.jsx)(B,{pid:w||"",onBack:ef,showToast:eg});default:return null}default:return null}})(),(0,r.jsx)(R,{activePage:i,onPageChange:ex}),Y&&(0,r.jsx)(D,{message:Y.message,type:Y.type,onClose:()=>$(null)})]})}}},function(e){e.O(0,[947,971,117,744],function(){return e(e.s=7181)}),_N_E=e.O()}]);